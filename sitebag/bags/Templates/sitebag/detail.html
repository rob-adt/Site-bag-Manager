<style>h2 {
    border-radius: 5%;
    border: 2px solid #fff;
    text-align: center;
    color: white;}
  table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 100%;}
  td, th {
    border: 1px solid #444;
    text-align: left;
    padding: 8px;
    color: white;}
</style>




{% load static %}
<link rel="shortcut icon" href="C:\Users\robert.weeks\OneDrive - AGH Engineering Ltd\Documents\GitHub\Site-bag-Manager\favicop.ico" type="image/x-icon">



<title>Bag Manager</title>




<body style="background-color: #444444;">
<h2>
  <text style="font-size:xx-large;  font-family: arial, sans-serif;">Available Bags for {{username}}</text>
  <form method="post" {% if authenticated %}action="/accounts/logout/">{% else %}action="/accounts/login/">{% endif %}
    {%csrf_token %}

    <button type="submit">
      {% if authenticated %}
      Log out

      {% else %}
      Log in
      {% endif %}</button>
  </form>

</h2>




<table>
  <thead>
    <tr>
      <th>Bag name</th>
      <th>Available</th>
      <th> contents </th>
      <th>User using it</th>
      <th>Date borrowed</th>
      <th>Date returned</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for bag in bags %}
    <tr>
      <td>{{ bag }}</td>
      <td>{% if bag.being_used %}False{% else %}True{% endif %}</td>
      <td>{{contents}}</td>
      <td>{{ bag.last_borrowingtime.member }}</td>
      <td>{{ bag.last_borrowingtime.start }}</td>
      <td>{% if bag.last_borrowingtime.end %}{{ bag.last_borrowingtime.end|date:"d/m/Y" }}{% endif %}</td>
      <td>
        {% if bag.being_used and bag.last_borrowingtime and username == bag.last_borrowingtime.member.user.username %}
          {% if authenticated %}
            <button onclick="returnBag('{{ bag.id }}')">Return</button>
          {% endif %}
        {% elif bag.being_used == False and authenticated %}
          <button onclick="borrowBag('{{ bag.id }}')">Borrow</button>
        {% else %}
          Not Authenticated
        {% endif %}
      </td>
      



    </tr>
    {% endfor %}    
<td><button onclick="addBag()">+ Add Bag</button></td>
  </tbody>
</table>




<script>
function addBag() {
  const bagName = prompt("Enter bag name:");
  if (bagName !== null && bagName.trim() !== "") {
    alert(`Bag "${bagName}" added successfully!`);
  } else {
    alert("No bag name entered.");
  }
}
</script>





<script>
function borrowBag(bagId) {
  fetch(`/borrow/${bagId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // alert('Bag borrowed by ' + data.member);
      location.reload();
    }
  });
}



function returnBag(bagId) {
  fetch(`/return/${bagId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // alert('Bag returned by ' + data.member);
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  }
)
;
}
</script>