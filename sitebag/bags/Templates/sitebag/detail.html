{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bag Manager</title>
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #121212;
      color: #f8f9fa;
    }
    .table thead th {
      border-bottom: 2px solid #666;
    }
    .card-body {
      background-color: #1e1e1e;
      color: #f8f9fa;
    }
    .navbar {
      border-bottom: 1px solid #444;
    }
    .btn-outline-light:hover {
      color: #000;
      background-color: #f8f9fa;
    }
    .table td, .table th {
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark px-3">
    <div class="container-fluid">
      <a class="navbar-brand fs-4">ðŸ‘œ Bag Manager â€” {{ username }}</a>

      <form method="post" {% if authenticated %}action="/accounts/logout/">{% else %}action="/accounts/login/">{% endif %}
        {% csrf_token %}
        <button class="btn btn-outline-light" type="submit">
          {% if authenticated %} Log out {% else %} Log in {% endif %}
        </button>
      </form>
    </div>
  </nav>

  <!-- Changed container to container-fluid -->
  <div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Available Bags</h2>
      <button class="btn btn-outline-success" onclick="addBag()">+ Add Bag</button>
    </div>

    <!-- Table now full width -->
    <div class="table-responsive w-100">
      <table class="table table-dark table-striped align-middle w-100">
        <thead>
          <tr>
            <th>Bag Name</th>
            <th>Contents</th>
            <th>User Using It</th>
            <th>Date Borrowed</th>
            <th>Date Returned</th>
            <th>Available</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for bag in bags %}
          <tr>
            <td class="fw-semibold">{{ bag }}</td>
            <td>
              <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#contents-{{ bag.id }}">
                Show Contents
              </button>

              
              <div class="collapse mt-2" id="contents-{{ bag.id }}">
                {% if authenticated %}



{% if bag.being_used and bag.last_borrowingtime and username == bag.last_borrowingtime.member.user.username %}
                {% if authenticated %}
                  <input class="card card-body p-2 max-width=40px" id="myInput" contenteditable="true" type="text" value="{{ bag.contents }}">
                {% endif %}
              {% elif not bag.being_used and authenticated %}
                <input class="card card-body p-2" id="myInput" contenteditable="true"  type="text" value="{{ bag.contents }}">
              {% else %}
                <input class="card card-body p-2" contenteditable="false"  type="text" value="{{ bag.contents }}">
              {% endif %}
              </input>
                {%endif%}
              
                {% if authenticated and not bag.being_used or bag.being_used and bag.last_borrowingtime and username == bag.last_borrowingtime.member.user.username %}
                  <button class="btn btn-sm btn-outline-primary" onclick="getText('{{ bag.id }}')">Save</button>
                {% else %}
                  <button class="btn btn-sm btn-outline-secondary" disabled>Not Authenticated</button>
                {% endif %}

                <p id="output"></p>


              </div>
            </td>

            <td>{{ bag.last_borrowingtime.member }}</td>
            <td>{{ bag.last_borrowingtime.start|date:"d/m/Y" }}</td>
            <td>{% if bag.last_borrowingtime.end %}{{ bag.last_borrowingtime.end|date:"d/m/Y" }}{% else %}â€”{% endif %}</td>

            <td>
              {% if bag.being_used %}
                <span class="badge bg-danger">Unavailable</span>
              {% else %}
                <span class="badge bg-success">Available</span>
              {% endif %}
            </td>

            <td>
              {% if bag.being_used and bag.last_borrowingtime and username == bag.last_borrowingtime.member.user.username %}
                {% if authenticated %}
                  <button class="btn btn-sm btn-outline-warning" onclick="returnBag('{{ bag.id }}')">Return</button>
                {% endif %}
              {% elif not bag.being_used and authenticated %}
                <button class="btn btn-sm btn-outline-success" onclick="borrowBag('{{ bag.id }}')">Borrow</button>
              {% else %}
                <button class="btn btn-sm btn-outline-secondary" disabled>Not Authenticated</button>
              {% endif %}

              
              {% if user.is_superuser %}
              <button class="btn btn-sm btn-outline-danger" onclick="deletebag('{{ bag.id }}')" >Delete</button>
              {% endif %}

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>



  function addBag() {
    const bagName = prompt("Enter bag name:");
    if (bagName && bagName.trim() !== "") {
      fetch('/add-bag/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bagName: bagName })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || data.error);
        location.reload();
      })
      .catch(() => alert("An error occurred."));
    } else {
      alert("No bag name entered.");
    }
  }


  function borrowBag(bagId) {
    fetch(`/borrow/${bagId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => data.success && location.reload());
  }

  function returnBag(bagId) {
    fetch(`/return/${bagId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) location.reload();
      else alert('Error: ' + (data.error || 'Unknown error'));
    });
  }

  function deletebag(bagId) {
          fetch(`/deletebag/${bagId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'},
      })
      .then(response => response.json())
    .then(data => {
      if (data.success) location.reload();
      else alert('Error: ' + (data.error || 'Unknown error'));
    });
  }


  function getText(bagId) {
    const inputElement = document.getElementById("myInput");
    const textValue = inputElement.value;
    document.getElementById("output").textContent = "You entered: " + textValue;
      fetch(`/contentsave/${bagId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'},
        body: textValue
      })
    }
  
  </script>
</body>
</html>
