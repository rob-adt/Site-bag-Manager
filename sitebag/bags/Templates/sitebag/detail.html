<style>
    h2 {
      border-radius: 5%;
      border: 2px solid rgb(255, 255, 255);
      text-align: center;
      color: white;
    }
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      width: 100%;
    }
    td,
    th {
      border: 1px solid #444444;
      text-align: left;
      padding: 8px;
      color: white;
    }
  </style>

{% load static %}
<link rel="shortcut icon" href="C:\Users\robert.weeks\OneDrive - AGH Engineering Ltd\Documents\GitHub\Site-bag-Manager\favicop.ico" type="image/x-icon">


<title>Bag Manager</title>

<body style="background-color: #444444;"></body>
<h2>
  <text style="font-size:xx-large;  font-family: arial, sans-serif;">Available Bags for {{username}}</text>
  <form method="post" {% if authenticated %}action="/accounts/logout/">{% else %}action="/accounts/login/">{% endif %}
    {%csrf_token %}

    <button type="submit">
      {% if authenticated %}
      Log out

      {% else %}
      Log in
      {% endif %}</button>
  </form>

</h2>


<table>
  <tr>
  <th style="color: white;">
      <th>Bag name</th>
      <th>Available</th>
      <th>user using it</th>
      <th>date borrowed</th>
      <th>date returned</th>
  </th>
  </tr>
  {% for bag in bags %}

  <tr>
  <td style="color: white;">
      <td>{{bag}}</td>
      <td>
        {% if bag.being_used %}
        False
        {% else %}
        True
        {% endif %}
      </td>

      <td>{{bag.last_borrowingtime.member}}</td>
      <td>{{bag.last_borrowingtime.start}}</td>
      <td>{{bag.last_borrowingtime.end}}</td>
      <td>


        {% if bag.being_used and bag.last_borrowingtime and username == bag.last_borrowingtime.member.user.username %}
          {% if authenticated %}
            
            <button onclick=" alert('Returned')">
              Return
              
            </button>
           {%endif%}

        {%elif bag.being_used == False and authenticated%}
          
          <button onclick="borrowBag('{% autoescape off %}{{ bag.id }}{% endautoescape %}')">Borrow</button>
        {%else%}
            Not Authenticated

        {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

<script>
function borrowBag(bagId) {
  fetch(`/borrow/${bagId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Bag borrowed by ' + data.member);
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  });
}
</script>